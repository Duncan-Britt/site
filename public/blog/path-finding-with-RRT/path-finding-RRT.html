<?xml version="1.0" encoding="utf-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN"
"http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html;charset=utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Path Planning With RRT</title>
<meta name="generator" content="Org Mode" />
<link rel="stylesheet" type="text/css" href="/stylesheets/color-scheme.css"/>
<link rel="stylesheet" type="text/css" href="/stylesheets/layout-blog.css"/>
<link rel="stylesheet" type="text/css" href="/stylesheets/blog-post.css"/>
<link rel="stylesheet" type="text/css" href="/stylesheets/htmlize2.css"/>
<script src="https://ajax.googleapis.com/ajax/libs/jquery/2.1.3/jquery.min.js"></script>
<script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.4/js/bootstrap.min.js"></script>
<script type="text/javascript" src="https://fniessen.github.io/org-html-themes/src/lib/js/jquery.stickytableheaders.min.js"></script>
<script type="text/javascript" src="https://fniessen.github.io/org-html-themes/src/readtheorg_theme/js/readtheorg.js"></script>
<link rel="stylesheet" type="text/css" href="./path-finding.css"/>
<script type="module" src="./path-finding.js"></script>
<script type="text/x-mathjax-config">
    MathJax.Hub.Config({
        displayAlign: "center",
        displayIndent: "0em",

        "HTML-CSS": { scale: 100,
                        linebreaks: { automatic: "false" },
                        webFont: "TeX"
                       },
        SVG: {scale: 100,
              linebreaks: { automatic: "false" },
              font: "TeX"},
        NativeMML: {scale: 100},
        TeX: { equationNumbers: {autoNumber: "AMS"},
               MultLineWidth: "85%",
               TagSide: "right",
               TagIndent: ".8em"
             }
});
</script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.0/MathJax.js?config=TeX-AMS_HTML"></script>
</head>
<body>
<div id="preamble" class="status">
<header>
    <nav>
        <a target="_self" href="/">About</a> -
        <a target="_self" href="/blog-posts.html">Blog</a> |
        <!-- <a target="_self" href="/portfolio.html">Portfolio</a> -         -->
        <!-- <a target="_self" href="/contact.html">Contact</a> - -->
        <!-- <a target="_self" href="/resume.html">Resume</a> | -->
        <a target="_blank" rel="noopener noreferrer" href="https://duncan-britt.github.io/splice-docs">Splice</a> -
        <a target="_blank" rel="noopener noreferrer" href="https://word-ladders.herokuapp.com/">Word Ladders</a>
        <!-- <a target="_blank" rel="noopener noreferrer" href="https://github.com/Duncan-Britt/">GitHub</a> -
             <a target="_blank" rel="noopener noreferrer" href="https://www.codewars.com/users/Duncan-Britt">Code Wars</a> -->
    </nav>
</header>
</div>
<div id="content" class="content">
<h1 class="title">Path Planning With RRT</h1>
<div id="table-of-contents" role="doc-toc">
<h2>Table of Contents</h2>
<div id="text-table-of-contents" role="doc-toc">
<ul>
<li><a href="#org7e7a8aa">RRT</a></li>
</ul>
</div>
</div>
<p>
In my last blog post, I demonstrated the A* path planning algorithm. In this blog post, we're going to go through a sampling based approach called Rapidly Expanding Random Trees (RRT).
</p>

<div id="outline-container-org7e7a8aa" class="outline-2">
<h2 id="org7e7a8aa">RRT</h2>
<div class="outline-text-2" id="text-org7e7a8aa">
<div id="grid-container"></div>

<p>
We're going to use a fast mathematical way of determining whether a straight line between two nodes intersects an obstacle. All of our obstacles are circles, and given the radius \(r_c\) and center of the circle \((Cx,Cy)\), we can write an equation for the circle in \(\mathbb{R}^2\):
\[(x - C_x)^2 + (y-C_y)^2 = r_c^2.\]
Let \(\vec{r_0}\) be the vector pointing to the point \(P\) of the nearest path node and \(Q\) be the coordinate point of the path node we are trying to connect to. An equation for the line \(r(t)\) between them is given by
</p>
\begin{align*}
r(t) & = \vec{r_0} + t \frac{\vec{PQ}}{\|\vec{PQ}\|}
\end{align*}
<p>
Let \(\vec{u}\) be the unit vector \[\frac{\vec{PQ}}{\|\vec{PQ}\|}\].
</p>
\begin{align*}
r(t) & = \vec{r_0} + t\vec{u} \\
     & = \langle x_0, y_0 \rangle + t \langle u_x, u_y \rangle \\
     & = \langle u_xt + x_0, u_yt + y_0 \rangle
\end{align*}

<p>
We need to find out if there is a point on the line that satisfies our equation for the circle, within a certain range of our parameter t, which corresponds to the distance we want to travel from our existing node.
</p>

<p>
We can do this by substituting the \(x\) and \(y\) components of \(r\) into our equation for our circle, and then solving for \(t\). If there are any real solutions, then the path between our nodes is obstructed by the obstacle.
\[\left(u_xt + x_{0} - C_{x} \right)^{2} + \left(u_yt + y_{0} - C_{y}\right)^{2} = r_{c}^{2}\]
Solving this equation by hand would get a little messy, but a few lines of python make short work of it.
</p>
<div class="org-src-container">
<pre class="src src-python"><span class="org-keyword">from</span> sympy <span class="org-keyword">import</span> symbols, expand, factor, latex, solve

<span class="org-variable-name">x0</span>, <span class="org-variable-name">ux</span>, <span class="org-variable-name">t</span>, <span class="org-variable-name">cx</span>, <span class="org-variable-name">y0</span>, <span class="org-variable-name">uy</span>, <span class="org-variable-name">cy</span>, <span class="org-variable-name">rc</span> = symbols(<span class="org-string">'x_0 u_x t C_x y_0 u_y C_y r_c'</span>)
<span class="org-variable-name">expr</span> = (ux*t + x0 - cx)**2 + (uy*t + y0 - cy)**2 - rc**2
<span class="org-variable-name">solutions</span> = solve(expr, t)
<span class="org-keyword">for</span> solution <span class="org-keyword">in</span> solutions:      
    <span class="org-builtin">print</span>(<span class="org-string">"$$"</span> + latex(solution) + <span class="org-string">"$$"</span>)
</pre>
</div>

<p>
\[\frac{C_{x} u_{x} + C_{y} u_{y} - u_{x} x_{0} - u_{y} y_{0} - \sqrt{- C_{x}^{2} u_{y}^{2} + 2 C_{x} C_{y} u_{x} u_{y} - 2 C_{x} u_{x} u_{y} y_{0} + 2 C_{x} u_{y}^{2} x_{0} - C_{y}^{2} u_{x}^{2} + 2 C_{y} u_{x}^{2} y_{0} - 2 C_{y} u_{x} u_{y} x_{0} + r_{c}^{2} u_{x}^{2} + r_{c}^{2} u_{y}^{2} - u_{x}^{2} y_{0}^{2} + 2 u_{x} u_{y} x_{0} y_{0} - u_{y}^{2} x_{0}^{2}}}{u_{x}^{2} + u_{y}^{2}}\]
\[\frac{C_{x} u_{x} + C_{y} u_{y} - u_{x} x_{0} - u_{y} y_{0} + \sqrt{- C_{x}^{2} u_{y}^{2} + 2 C_{x} C_{y} u_{x} u_{y} - 2 C_{x} u_{x} u_{y} y_{0} + 2 C_{x} u_{y}^{2} x_{0} - C_{y}^{2} u_{x}^{2} + 2 C_{y} u_{x}^{2} y_{0} - 2 C_{y} u_{x} u_{y} x_{0} + r_{c}^{2} u_{x}^{2} + r_{c}^{2} u_{y}^{2} - u_{x}^{2} y_{0}^{2} + 2 u_{x} u_{y} x_{0} y_{0} - u_{y}^{2} x_{0}^{2}}}{u_{x}^{2} + u_{y}^{2}}\]
</p>

<p>
This may look messy, but all of these values are known constants. And since we don't actually need to know the points of intersection, we're really only interested in whether the part under the radical is greater than 0.
</p>

<div class="org-src-container">
<pre class="src src-js">-cx**2 * dy**2 + 2 * cx * cy * dx * dy - 2cx * dx * dy * y0 + 2 * cx * dy**2 * x0 - cy**2 * dx**2 + 2 * cy * dx**2 * y0 - 2 * cy * dx * dy * xo + dx**2 * rc**2 - dx**2 * y0**2 + 2 * dx * dy * xo * y0 + dy**2 * rc**2 - dy**2 * x0**2 &gt;= 0 ? 
</pre>
</div>

<div class="org-src-container">
<pre class="src src-js"><span class="linenr">  0: </span>document.addEventListener(<span class="org-string">"DOMContentLoaded"</span>, () =&gt; {
<span class="linenr">  1: </span>  canvasRRT({
<span class="linenr">  2: </span>    canvas_container: document.querySelector(<span class="org-string">'#grid-container'</span>),
<span class="linenr">  3: </span>    width: 400,
<span class="linenr">  4: </span>    height: 400,
<span class="linenr">  5: </span>    objects: [
<span class="linenr">  6: </span>      <span class="org-keyword">new</span> <span class="org-type">Circle</span>({ center: { x: 10, y: 391 }, radius: 10, color: <span class="org-string">"red"</span>, }),
<span class="linenr">  7: </span>      <span class="org-keyword">new</span> <span class="org-type">Circle</span>({ center: { x: 389, y: 10 }, radius: 10, color: <span class="org-string">"red"</span>, }),
<span class="linenr">  8: </span>      <span class="org-keyword">new</span> <span class="org-type">Circle</span>({ center: { x: 294, y: 150 }, radius: 40, color: <span class="org-string">"black"</span>, }),
<span class="linenr">  9: </span>      <span class="org-keyword">new</span> <span class="org-type">Circle</span>({ center: { x: 164, y: 269 }, radius: 40, color: <span class="org-string">"black"</span>, }),
<span class="linenr"> 10: </span>      <span class="org-keyword">new</span> <span class="org-type">Circle</span>({ center: { x: 179, y: 152 }, radius: 30, color: <span class="org-string">"black"</span>, }),
<span class="linenr"> 11: </span>    ],
<span class="linenr"> 12: </span>  });
<span class="linenr"> 13: </span>});
<span class="linenr"> 14: </span>
<span class="linenr"> 15: </span><span class="org-keyword">class</span> Circle {
<span class="linenr"> 16: </span>  constructor({ center, radius, color }) {
<span class="linenr"> 17: </span>    <span class="org-constant">this</span>.center = center;
<span class="linenr"> 18: </span>    <span class="org-constant">this</span>.radius = radius;
<span class="linenr"> 19: </span>    <span class="org-constant">this</span>.color = color;
<span class="linenr"> 20: </span>  }
<span class="linenr"> 21: </span>
<span class="linenr"> 22: </span>  within(x, y) {
<span class="linenr"> 23: </span>    <span class="org-keyword">return</span> distance({ x, y }, <span class="org-constant">this</span>.center) &lt;= <span class="org-constant">this</span>.radius;
<span class="linenr"> 24: </span>  }
<span class="linenr"> 25: </span>}
<span class="linenr"> 26: </span>
<span class="linenr"> 27: </span><span class="org-keyword">function</span> <span class="org-function-name">distance</span>(<span class="org-variable-name">a</span>, <span class="org-variable-name">b</span>) {
<span class="linenr"> 28: </span>  <span class="org-keyword">return</span> Math.sqrt(Math.pow(b.y - a.y, 2) + Math.pow(b.x - a.x, 2));
<span class="linenr"> 29: </span>}
<span class="linenr"> 30: </span>
<span class="linenr"> 31: </span><span class="org-keyword">class</span> PathNode {
<span class="linenr"> 32: </span>  constructor(x, y, parent = <span class="org-constant">null</span>) {
<span class="linenr"> 33: </span>    <span class="org-constant">this</span>.x = x;
<span class="linenr"> 34: </span>    <span class="org-constant">this</span>.y = y;
<span class="linenr"> 35: </span>    <span class="org-constant">this</span>.parent = parent;
<span class="linenr"> 36: </span>  }
<span class="linenr"> 37: </span>}
<span class="linenr"> 38: </span>
<span class="linenr"> 39: </span><span class="org-keyword">function</span> <span class="org-function-name">canvasRRT</span>({ canvas_container, width, height, objects }) {
<span class="linenr"> 40: </span>  <span class="org-keyword">let</span> <span class="org-variable-name">canvas</span> = document.createElement(<span class="org-string">'canvas'</span>);
<span class="linenr"> 41: </span>  canvas.style.border = <span class="org-string">"6px solid black"</span>;
<span class="linenr"> 42: </span>  canvas.style.touchAction = <span class="org-string">'none'</span>; <span class="org-comment-delimiter">// </span><span class="org-comment">Prevent scroll on touch screen devices.</span>
<span class="linenr"> 43: </span>  canvas.width = width
<span class="linenr"> 44: </span>  canvas.height = height
<span class="linenr"> 45: </span>  canvas_container.appendChild(canvas);
<span class="linenr"> 46: </span>  <span class="org-keyword">let</span> <span class="org-variable-name">cx</span> = canvas.getContext(<span class="org-string">"2d"</span>);
<span class="linenr"> 47: </span>  <span class="org-keyword">let</span> <span class="org-variable-name">path</span>;
<span class="linenr"> 48: </span>
<span class="linenr"> 49: </span>  <span class="org-keyword">const</span> <span class="org-variable-name">draw_objects</span> = () =&gt; {
<span class="linenr"> 50: </span>    objects.forEach(object =&gt; {
<span class="linenr"> 51: </span>      cx.beginPath();
<span class="linenr"> 52: </span>      <span class="org-comment-delimiter">// </span><span class="org-comment">center=(x,y) radius=r angle=0 to 7</span>
<span class="linenr"> 53: </span>      cx.arc(object.center.x, object.center.y, object.radius, 0, 7);
<span class="linenr"> 54: </span>      cx.fillStyle = object.color;
<span class="linenr"> 55: </span>      cx.fill();
<span class="linenr"> 56: </span>      cx.closePath();
<span class="linenr"> 57: </span>    });
<span class="linenr"> 58: </span>  };
<span class="linenr"> 59: </span>
<span class="linenr"> 60: </span>  <span class="org-keyword">const</span> <span class="org-variable-name">render_grid</span> = () =&gt; {
<span class="linenr"> 61: </span>    <span class="org-comment-delimiter">// </span><span class="org-comment">Give the canvas a blue background:</span>
<span class="linenr"> 62: </span>    cx.fillStyle = <span class="org-string">"#2980B9"</span>;
<span class="linenr"> 63: </span>    cx.fillRect(0, 0, width, height);
<span class="linenr"> 64: </span>    draw_objects();
<span class="linenr"> 65: </span>  }
<span class="linenr"> 66: </span>  render_grid();
<span class="linenr"> 67: </span>
<span class="linenr"> 68: </span>  <span class="org-keyword">let</span> <span class="org-variable-name">object_grabbed_idx</span> = -1;
<span class="linenr"> 69: </span>  <span class="org-keyword">let</span> <span class="org-variable-name">object_hovered_idx</span> = -1;
<span class="linenr"> 70: </span>
<span class="linenr"> 71: </span>  <span class="org-keyword">const</span> <span class="org-variable-name">press_handler</span> = e =&gt; {
<span class="linenr"> 72: </span>    e.stopPropagation();
<span class="linenr"> 73: </span>    e.preventDefault();
<span class="linenr"> 74: </span>    object_grabbed_idx = objects.reduce((res, object, current_idx) =&gt; {
<span class="linenr"> 75: </span>      <span class="org-keyword">return</span> object.within(e.offsetX, e.offsetY) ?  current_idx : res;
<span class="linenr"> 76: </span>    }, -1); <span class="org-comment-delimiter">// </span><span class="org-comment">-1 indicates no object grabbed</span>
<span class="linenr"> 77: </span>
<span class="linenr"> 78: </span>    object_hovered_idx = object_grabbed_idx;
<span class="linenr"> 79: </span>    <span class="org-keyword">if</span> (object_grabbed_idx != -1) {
<span class="linenr"> 80: </span>      canvas.style.cursor = <span class="org-string">"grabbing"</span>;
<span class="linenr"> 81: </span>    }
<span class="linenr"> 82: </span>  };
<span class="linenr"> 83: </span>
<span class="linenr"> 84: </span>  <span class="org-keyword">const</span> <span class="org-variable-name">move_handler</span> = e =&gt; {
<span class="linenr"> 85: </span>    e.stopPropagation();
<span class="linenr"> 86: </span>    e.preventDefault();
<span class="linenr"> 87: </span>
<span class="linenr"> 88: </span>    <span class="org-keyword">if</span> (object_grabbed_idx == -1) {
<span class="linenr"> 89: </span>      object_hovered_idx = objects.reduce((res, object, current_idx) =&gt; {
<span class="linenr"> 90: </span>        <span class="org-keyword">return</span> object.within(e.offsetX, e.offsetY) ?  current_idx : res;
<span class="linenr"> 91: </span>      }, -1); <span class="org-comment-delimiter">// </span><span class="org-comment">-1 indicates no object hovered over</span>
<span class="linenr"> 92: </span>      <span class="org-keyword">if</span> (object_hovered_idx == -1) {
<span class="linenr"> 93: </span>        canvas.style.cursor = <span class="org-string">"crosshair"</span>
<span class="linenr"> 94: </span>      } <span class="org-keyword">else</span> {
<span class="linenr"> 95: </span>        canvas.style.cursor = <span class="org-string">"grab"</span>
<span class="linenr"> 96: </span>      }
<span class="linenr"> 97: </span>
<span class="linenr"> 98: </span>      <span class="org-keyword">return</span>;
<span class="linenr"> 99: </span>    }
<span class="linenr">100: </span>
<span class="linenr">101: </span>    <span class="org-keyword">let</span> <span class="org-variable-name">x</span> = e.offsetX;
<span class="linenr">102: </span>    <span class="org-keyword">let</span> <span class="org-variable-name">y</span> = e.offsetY;
<span class="linenr">103: </span>    <span class="org-keyword">if</span> (x &lt; 0 || y &lt; 0 || x &gt;= canvas.width || y &gt;= canvas.height) {
<span class="linenr">104: </span>      <span class="org-keyword">return</span>;
<span class="linenr">105: </span>    }
<span class="linenr">106: </span>
<span class="linenr">107: </span>    objects[object_grabbed_idx].center = { x, y };
<span class="linenr">108: </span>    render_grid();
<span class="linenr">109: </span>  };
<span class="linenr">110: </span>
<span class="linenr">111: </span>  <span class="org-keyword">const</span> <span class="org-variable-name">RRT</span> = () =&gt; {
<span class="linenr">112: </span>    <span class="org-keyword">const</span> <span class="org-variable-name">MAX_BRANCH_LENGTH</span> = 50;
<span class="linenr">113: </span>    <span class="org-keyword">const</span> <span class="org-variable-name">PROXIMITY_THRESHOLD</span> = 10;
<span class="linenr">114: </span>    <span class="org-keyword">const</span> <span class="org-variable-name">MAX_ITERATIONS</span> = 10000;
<span class="linenr">115: </span>
<span class="linenr">116: </span>    <span class="org-keyword">let</span> <span class="org-variable-name">path_nodes</span> = [<span class="org-keyword">new</span> <span class="org-type">PathNode</span>(objects[0].center.x, objects[0].center.y)];
<span class="linenr">117: </span>
<span class="linenr">118: </span>    <span class="org-keyword">let</span> <span class="org-variable-name">iterations</span> = 0;
<span class="linenr">119: </span>    <span class="org-keyword">while</span> (iterations &lt;= MAX_ITERATIONS) {
<span class="linenr">120: </span>      <span class="org-comment-delimiter">// </span><span class="org-comment">randomly sample a point, (xs, ys) </span>
<span class="linenr">121: </span>      <span class="org-keyword">let</span> [<span class="org-variable-name">xs</span>, <span class="org-variable-name">ys</span>] = [Math.random() * canvas.width, Math.random() * canvas.height];
<span class="linenr">122: </span>      <span class="org-comment-delimiter">// </span><span class="org-comment">Find the nearest node in the tree</span>
<span class="linenr">123: </span>      <span class="org-keyword">let</span> <span class="org-variable-name">nearest_node</span> = path_nodes.reduce((nearest, node) =&gt; {
<span class="linenr">124: </span>        <span class="org-keyword">return</span> distance(node, { x: xs, y: ys }) &lt; distance(nearest, { x: xs, y: ys }) ? node : nearest;
<span class="linenr">125: </span>      });
<span class="linenr">126: </span>      <span class="org-keyword">const</span> <span class="org-variable-name">dx</span> = xs - nearest_node.x;
<span class="linenr">127: </span>      <span class="org-keyword">const</span> <span class="org-variable-name">dy</span> = ys - nearest_node.y;
<span class="linenr">128: </span>      <span class="org-keyword">const</span> <span class="org-variable-name">magnitude</span> = Math.sqrt(dx**2 + dy**2);
<span class="linenr">129: </span>      <span class="org-keyword">const</span> <span class="org-variable-name">ux</span> = dx / magnitude;
<span class="linenr">130: </span>      <span class="org-keyword">const</span> <span class="org-variable-name">uy</span> = dy / magnitude;
<span class="linenr">131: </span>      <span class="org-keyword">const</span> <span class="org-variable-name">r</span> = t =&gt; {          
<span class="linenr">132: </span>        <span class="org-keyword">return</span> [ ux * t + nearest_node.x, uy * t + nearest_node.y ];
<span class="linenr">133: </span>      };
<span class="linenr">134: </span>
<span class="linenr">135: </span>      <span class="org-comment-delimiter">// </span><span class="org-comment">Does the line r(t) through the nearest node and the sample point intersect with any of the circles?</span>
<span class="linenr">136: </span>      <span class="org-comment-delimiter">//   </span><span class="org-comment">If not, make a new node in the direction of r(t)</span>
<span class="linenr">137: </span>      <span class="org-comment-delimiter">//   </span><span class="org-comment">If so, does it intersect the circle in the range 0 &lt;= t &lt;= MAX_t ?</span>
<span class="linenr">138: </span>      <span class="org-comment-delimiter">//     </span><span class="org-comment">if both are true, then resample.</span>
<span class="linenr">139: </span>      <span class="org-comment-delimiter">//     </span><span class="org-comment">Otherwise, the path is clear, make a new node in the direction of r(t)</span>
<span class="linenr">140: </span>      <span class="org-keyword">let</span> <span class="org-variable-name">t1</span>;
<span class="linenr">141: </span>      <span class="org-keyword">let</span> <span class="org-variable-name">t2</span>;
<span class="linenr">142: </span>      <span class="org-keyword">if</span> (objects.slice(2).some(circle =&gt; {
<span class="linenr">143: </span>        <span class="org-keyword">const</span> <span class="org-variable-name">cx</span> = circle.center.x;
<span class="linenr">144: </span>        <span class="org-keyword">const</span> <span class="org-variable-name">cy</span> = circle.center.y;
<span class="linenr">145: </span>        <span class="org-keyword">const</span> <span class="org-variable-name">x0</span> = nearest_node.x;
<span class="linenr">146: </span>        <span class="org-keyword">const</span> <span class="org-variable-name">y0</span> = nearest_node.y;
<span class="linenr">147: </span>        <span class="org-keyword">const</span> <span class="org-variable-name">rc</span> = circle.radius;
<span class="linenr">148: </span>        <span class="org-keyword">const</span> <span class="org-variable-name">under_root</span> = -(cx**2) * uy**2 + 2 * cx * cy * ux * uy - 2 * cx * ux * uy * y0 + 2 * cx * uy**2 * x0 - cy**2 * ux**2 + 2 * cy * ux**2 * y0 - 2 * cy * ux * uy * x0 + ux**2 * rc**2 + rc**2 * uy**2 - ux**2 * y0**2 + 2 * ux * uy * x0 * y0 - uy**2 * x0**2;
<span class="linenr">149: </span>        <span class="org-keyword">if</span> (under_root &lt; 0) {
<span class="linenr">150: </span>          <span class="org-keyword">return</span> <span class="org-constant">false</span>;
<span class="linenr">151: </span>        }
<span class="linenr">152: </span>        <span class="org-comment-delimiter">// </span><span class="org-comment">now we need to know if it has a solution on a range of t</span>
<span class="linenr">153: </span>        <span class="org-keyword">let</span> <span class="org-variable-name">a</span> = cx * ux + cy * uy - ux * x0 - uy * y0;
<span class="linenr">154: </span>        <span class="org-keyword">let</span> <span class="org-variable-name">denom</span> = ux**2 + uy**2;
<span class="linenr">155: </span>        t1 = (a - Math.sqrt(under_root)) / denom;
<span class="linenr">156: </span>        t2 = (a + Math.sqrt(under_root)) / denom;
<span class="linenr">157: </span>        <span class="org-keyword">if</span> (Math.min(t1, t2) &lt; MAX_BRANCH_LENGTH) {
<span class="linenr">158: </span>          <span class="org-keyword">return</span> <span class="org-constant">true</span>;
<span class="linenr">159: </span>        }
<span class="linenr">160: </span>        <span class="org-keyword">return</span> <span class="org-constant">false</span>;
<span class="linenr">161: </span>      })) {
<span class="linenr">162: </span>        <span class="org-keyword">continue</span>;
<span class="linenr">163: </span>      }
<span class="linenr">164: </span>
<span class="linenr">165: </span>      <span class="org-keyword">const</span> <span class="org-variable-name">new_node</span> = <span class="org-keyword">new</span> <span class="org-type">PathNode</span>(
<span class="linenr">166: </span>        ...r(Math.min(MAX_BRANCH_LENGTH, distance(nearest_node, { x: xs, y: ys }))),
<span class="linenr">167: </span>        nearest_node
<span class="linenr">168: </span>      );
<span class="linenr">169: </span>      path_nodes.push(new_node);
<span class="linenr">170: </span>
<span class="linenr">171: </span>      <span class="org-comment-delimiter">// </span><span class="org-comment">let node_circle = new Circle({ center: new_node, radius: 2, color: "yellow"});</span>
<span class="linenr">172: </span>      <span class="org-comment-delimiter">// </span><span class="org-comment">cx.beginPath();</span>
<span class="linenr">173: </span>      <span class="org-comment-delimiter">// </span><span class="org-comment">// center=(x,y) radius=r angle=0 to 7        </span>
<span class="linenr">174: </span>      <span class="org-comment-delimiter">// </span><span class="org-comment">cx.arc(node_circle.center.x, node_circle.center.y, node_circle.radius, 0, 7);</span>
<span class="linenr">175: </span>      <span class="org-comment-delimiter">// </span><span class="org-comment">cx.fillStyle = node_circle.color;</span>
<span class="linenr">176: </span>      <span class="org-comment-delimiter">// </span><span class="org-comment">cx.fill();</span>
<span class="linenr">177: </span>      <span class="org-comment-delimiter">// </span><span class="org-comment">cx.closePath();</span>
<span class="linenr">178: </span>
<span class="linenr">179: </span>      <span class="org-keyword">if</span> (distance(new_node, objects[1].center) &lt; PROXIMITY_THRESHOLD) {
<span class="linenr">180: </span>        <span class="org-keyword">let</span> <span class="org-variable-name">node</span> = new_node;
<span class="linenr">181: </span>        path = [];
<span class="linenr">182: </span>        <span class="org-keyword">while</span> (node <span class="org-keyword">instanceof</span> <span class="org-type">PathNode</span>) {
<span class="linenr">183: </span>          path.push(node);
<span class="linenr">184: </span>          node = node.parent;
<span class="linenr">185: </span>        }
<span class="linenr">186: </span>        <span class="org-keyword">return</span> 0;
<span class="linenr">187: </span>      }
<span class="linenr">188: </span>
<span class="linenr">189: </span>      iterations += 1;        
<span class="linenr">190: </span>    }
<span class="linenr">191: </span>    <span class="org-keyword">return</span> -5;
<span class="linenr">192: </span>  };
<span class="linenr">193: </span>
<span class="linenr">194: </span>  <span class="org-keyword">const</span> <span class="org-variable-name">unclick_handler</span> = e =&gt; {
<span class="linenr">195: </span>    object_grabbed_idx = -1;
<span class="linenr">196: </span>    canvas.style.cursor = object_hovered_idx == -1 ? <span class="org-string">"crosshair"</span> : <span class="org-string">"grab"</span>;
<span class="linenr">197: </span>    <span class="org-comment-delimiter">// </span><span class="org-comment">should return an error code and mutate the path</span>
<span class="linenr">198: </span>    <span class="org-keyword">let</span> <span class="org-variable-name">err</span> = RRT();
<span class="linenr">199: </span>    <span class="org-keyword">if</span> (err == 0) {
<span class="linenr">200: </span>      cx.strokeStyle = <span class="org-string">"red"</span>;
<span class="linenr">201: </span>      cx.lineWidth = 1;
<span class="linenr">202: </span>      cx.lineJoin = <span class="org-string">"round"</span>;
<span class="linenr">203: </span>      cx.beginPath();
<span class="linenr">204: </span>      cx.moveTo(path[0].x, path[0].y);
<span class="linenr">205: </span>      path.forEach(node =&gt; {
<span class="linenr">206: </span>        <span class="org-keyword">let</span> <span class="org-variable-name">node_circle</span> = <span class="org-keyword">new</span> <span class="org-type">Circle</span>({ center: node, radius: 2, color: <span class="org-string">"yellow"</span>});
<span class="linenr">207: </span>        cx.lineTo(node.x, node.y);          
<span class="linenr">208: </span>      });
<span class="linenr">209: </span>      cx.stroke();
<span class="linenr">210: </span>    } <span class="org-keyword">else</span> {
<span class="linenr">211: </span>      console.error(err);
<span class="linenr">212: </span>    }
<span class="linenr">213: </span>  };
<span class="linenr">214: </span>
<span class="linenr">215: </span>  canvas.addEventListener(<span class="org-string">'mousedown'</span>, press_handler, <span class="org-constant">true</span>);
<span class="linenr">216: </span>  canvas.addEventListener(<span class="org-string">'pointerdown'</span>, press_handler, <span class="org-constant">true</span>);
<span class="linenr">217: </span>  canvas.addEventListener(<span class="org-string">'mousemove'</span>, move_handler, <span class="org-constant">true</span>);
<span class="linenr">218: </span>  canvas.addEventListener(<span class="org-string">'pointermove'</span>, move_handler, <span class="org-constant">true</span>);
<span class="linenr">219: </span>  window.addEventListener(<span class="org-string">'mouseup'</span>, unclick_handler, <span class="org-constant">true</span>);      
<span class="linenr">220: </span>  window.addEventListener(<span class="org-string">'pointerup'</span>, unclick_handler, <span class="org-constant">true</span>);    
<span class="linenr">221: </span>}
</pre>
</div>
</div>
</div>
</div>
<div id="postamble" class="status">
<p class="date">Date: 2023-03-12 Sun 00:00</p>
</div>
</body>
</html>
